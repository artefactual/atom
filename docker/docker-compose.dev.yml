---
version: "3.7"

networks:
  solr:

volumes:
  elasticsearch_data:
  percona_data:
  composer_deps:
  npm_deps:
  solr-data:

services:

  zoo1:
    image: zookeeper
    container_name: zoo1
    restart: always
    hostname: zoo1
    ports:
      - 2181:2181
      - 7001:7000
    environment:
      ZOO_MY_ID: 1
      ZOO_SERVERS: server.1=zoo1:2888:3888;2181 server.2=zoo2:2888:3888;2181 server.3=zoo3:2888:3888;2181
      ZOO_4LW_COMMANDS_WHITELIST: mntr, conf, ruok
      ZOO_CFG_EXTRA: "metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider metricsProvider.httpPort=7000 metricsProvider.exportJvmInfo=true"
    networks:
      - solr

  zoo2:
    image: zookeeper
    container_name: zoo2
    restart: always
    hostname: zoo2
    ports:
      - 2182:2181
      - 7002:7000
    environment:
      ZOO_MY_ID: 2
      ZOO_SERVERS: server.1=zoo1:2888:3888;2181 server.2=zoo2:2888:3888;2181 server.3=zoo3:2888:3888;2181
      ZOO_4LW_COMMANDS_WHITELIST: mntr, conf, ruok
      ZOO_CFG_EXTRA: "metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider metricsProvider.httpPort=7000 metricsProvider.exportJvmInfo=true"
    networks:
      - solr

  zoo3:
    image: zookeeper
    container_name: zoo3
    restart: always
    hostname: zoo3
    ports:
      - 2183:2181
      - 7003:7000
    environment:
      ZOO_MY_ID: 3
      ZOO_SERVERS: server.1=zoo1:2888:3888;2181 server.2=zoo2:2888:3888;2181 server.3=zoo3:2888:3888;2181
      ZOO_4LW_COMMANDS_WHITELIST: mntr, conf, ruok
      ZOO_CFG_EXTRA: "metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider metricsProvider.httpPort=7000 metricsProvider.exportJvmInfo=true"
    networks:
      - solr

  solr1:
    image: solr
    container_name: solr1
    ports:
     - "8981:8983"
    environment:
      - ZK_HOST=zoo1:2181,zoo2:2181,zoo3:2181
    networks:
      - solr
    depends_on:
      - zoo1
      - zoo2
      - zoo3
    volumes:
      - solr-data:/var/solr

  solr2:
    image: solr
    container_name: solr2
    ports:
     - "8982:8983"
    environment:
      - ZK_HOST=zoo1:2181,zoo2:2181,zoo3:2181
    networks:
      - solr
    depends_on:
      - zoo1
      - zoo2
      - zoo3
    volumes:
      - solr-data:/var/solr

  solr3:
    image: solr
    container_name: solr3
    ports:
     - "8983:8983"
    environment:
      - ZK_HOST=zoo1:2181,zoo2:2181,zoo3:2181
    networks:
      - solr
    depends_on:
      - zoo1
      - zoo2
      - zoo3
    volumes:
      - solr-data:/var/solr

  atom:
    build: ..
    env_file: etc/environment
    environment:
      - ATOM_COVERAGE=${ATOM_COVERAGE:-false}
    volumes:
      - composer_deps:/atom/src/vendor/composer
      - npm_deps:/atom/src/node_modules
      - ..:/atom/src:rw
      - ../solr:/solr
    networks:
      - solr

  atom_worker:
    build: ..
    command: worker
    env_file: etc/environment
    environment:
      - ATOM_COVERAGE=${ATOM_COVERAGE:-false}
    depends_on:
      - gearmand
      - percona
    restart: on-failure:5
    volumes:
      - composer_deps:/atom/src/vendor/composer
      - npm_deps:/atom/src/node_modules
      - ..:/atom/src:rw
    networks:
      - solr

  nginx:
    image: nginx:latest
    volumes:
      - composer_deps:/atom/src/vendor/composer
      - npm_deps:/atom/src/node_modules
      - ..:/atom/src:ro
      - ./etc/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ../solr:/solr
    ports:
      - "63001:80"
      - "9001:81"
    networks:
      - solr

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:5.6.16
    env_file: etc/environment
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    ports:
      - "127.0.0.1:63002:9200"
    networks:
      - solr

  percona:
    image: percona:8.0
    env_file: etc/environment
    volumes:
      - percona_data:/var/lib/mysql:rw
      - ./etc/mysql/mysqld.cnf:/etc/my.cnf.d/mysqld.cnf:ro
    ports:
      - "127.0.0.1:63003:3306"
    networks:
      - solr

  memcached:
    image: memcached
    command: -p 11211 -m 128 -u memcache
    ports:
      - "127.0.0.1:63004:11211"
    networks:
      - solr

  gearmand:
    image: artefactual/gearmand
    ports:
      - "127.0.0.1:63005:4730"
    networks:
      - solr
